<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>spring - 心之所动，且就随缘而去吧</title>
    <meta name="keywords" content=""/>
    <meta name="description" content="侯铭健的个人wiki"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/wiki/">Home</a>&nbsp;&#187;&nbsp;<a href="/wiki/#Java">Java</a>&nbsp;&#187;&nbsp;spring
    <span class="updated">Page Updated&nbsp;
      2016-06-24 16:57:46
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">spring</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#spring">搭建Spring环境</a></li>
<li><a href="#_1">整合数据库</a><ul>
<li><a href="#jdbc">配置jdbc信息</a></li>
<li><a href="#hibernate">整合hibernate</a></li>
<li><a href="#mybatis">整合mybatis</a></li>
</ul>
</li>
<li><a href="#spring_1">Spring事务配置</a><ul>
<li><a href="#aop">AOP层控制事务</a></li>
<li><a href="#_2">注解控制事务</a></li>
</ul>
</li>
<li><a href="#springmybaits">Spring整合Mybaits</a><ul>
<li><a href="#mybatis_1">配置mybatis的环境</a></li>
</ul>
</li>
<li><a href="#aop_1">AOP</a><ul>
<li><a href="#aop_2">事务注解和AOP注解</a></li>
</ul>
</li>
<li><a href="#spring-cache">Spring-cache</a></li>
<li><a href="#quartz">Quartz定时任务</a></li>
<li><a href="#springjar">spring引用jar包里面的配置文件</a><ul>
<li><a href="#spring_2">spring扫描</a></li>
<li><a href="#aop_3">开启aop</a></li>
<li><a href="#spring-test">Spring-test</a></li>
</ul>
</li>
<li><a href="#spring_3">Spring加载顺序比静态类加载慢的问题</a></li>
</ul>
</div>
<h3 id="spring">搭建Spring环境</h3>
<p>1、导入所有的Spring包</p>
<div class="hlcode"><pre><span class="c">&lt;!-- spring开始 --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-core<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-oxm<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-tx<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-webmvc<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-aop<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context-support<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>


<p>2、配置web.xml</p>
<p>如果工程没有web的部分，或者并没有使用到spring-mvc，则不需要配置该文件</p>
<div class="hlcode"><pre><span class="cp">&lt;!DOCTYPE web-app PUBLIC</span>
<span class="cp">        &quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span>
<span class="cp">        &quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot; &gt;</span>
<span class="nt">&lt;web-app&gt;</span>
    <span class="nt">&lt;display-name&gt;</span>Archetype Created Web Application<span class="nt">&lt;/display-name&gt;</span>

    <span class="c">&lt;!-- Spring的配置文件 --&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>classpath:spring/spring-common<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>

    <span class="c">&lt;!--log4j--&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>log4jConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>WEB-INF/log4j.properties<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>

    <span class="c">&lt;!-- 编码过滤器 --&gt;</span>
    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>encodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
        <span class="nt">&lt;async-supported&gt;</span>true<span class="nt">&lt;/async-supported&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>encoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>UTF-8<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>encodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="c">&lt;!-- Spring监听器 --&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="c">&lt;!-- 防止Spring内存溢出监听器 --&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.util.Log4jConfigListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>

    <span class="c">&lt;!-- Spring MVC servlet --&gt;</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>SpringMVC<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>classpath:spring/spring-mvc.xml<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
        <span class="nt">&lt;async-supported&gt;</span>true<span class="nt">&lt;/async-supported&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>SpringMVC<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>

    <span class="nt">&lt;welcome-file-list&gt;</span>
        <span class="nt">&lt;welcome-file&gt;</span>/index.jsp<span class="nt">&lt;/welcome-file&gt;</span>
    <span class="nt">&lt;/welcome-file-list&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</pre></div>


<p>配置spring-common.xml文件</p>
<div class="hlcode"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
<span class="s">      http://www.springframework.org/schema/context</span>
<span class="s">      http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 扫描文件（自动将service层注入） --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.houmingjian.practice.service&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 扫描dao层 --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.houmingjian.practice.dao&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>


<p>然后就是配置Spring的数据库事项了。在hibernate中有提到。</p>
<h3 id="_1">整合数据库</h3>
<h5 id="jdbc">配置jdbc信息</h5>
<p>jdbc.properties</p>
<div class="hlcode"><pre><span class="na">jdbc.driver</span><span class="o">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="na">jdbc.url</span><span class="o">=</span><span class="s">jdbc\:mysql\://localhost\:3306/practice</span>
<span class="na">jdbc.username</span><span class="o">=</span><span class="s">root</span>
<span class="na">jdbc.password</span><span class="o">=</span><span class="s">root</span>
</pre></div>


<h5 id="hibernate">整合hibernate</h5>
<p>spring的配置文件中加入（最好是新建一个spring配置文件spring-hibernate）</p>
<div class="hlcode"><pre><span class="c">&lt;!-- 读取jdbc文件 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.beans.factory.config.PreferencesPlaceholderConfigurer&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;locations&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;list&gt;</span>
                <span class="nt">&lt;value&gt;</span>classpath:jdbc.properties<span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 用户名 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;user&quot;</span> <span class="na">value=</span><span class="s">&quot;${jdbc.username}&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 用户密码 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${jdbc.password}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClass&quot;</span> <span class="na">value=</span><span class="s">&quot;${jdbc.driver}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jdbcUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${jdbc.url}&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!--连接池中保留的最大连接数。默认值: 15 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxPoolSize&quot;</span> <span class="na">value=</span><span class="s">&quot;20&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 连接池中保留的最小连接数，默认为：3 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minPoolSize&quot;</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 初始化连接池中的连接数，取值应在minPoolSize与maxPoolSize之间，默认为3 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;initialPoolSize&quot;</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!--最大空闲时间，60秒内未使用则连接被丢弃。若为0则永不丢弃。默认值: 0 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdleTime&quot;</span> <span class="na">value=</span><span class="s">&quot;60&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!-- 当连接池连接耗尽时，客户端调用getConnection()后等待获取新连接的时间，超时后将抛出SQLException，如设为0则无限期等待。单位毫秒。默认: </span>
<span class="c">            0 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkoutTimeout&quot;</span> <span class="na">value=</span><span class="s">&quot;3000&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!--当连接池中的连接耗尽的时候c3p0一次同时获取的连接数。默认值: 3 --&gt;</span>
        <span class="c">&lt;!-- &lt;property name=&quot;acquireIncrement&quot; value=&quot;2&quot;/&gt; --&gt;</span>

        <span class="c">&lt;!--定义在从数据库获取新连接失败后重复尝试的次数。默认值: 30 ；小于等于0表示无限次 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;acquireRetryAttempts&quot;</span> <span class="na">value=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!--重新尝试的时间间隔，默认为：1000毫秒 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;acquireRetryDelay&quot;</span> <span class="na">value=</span><span class="s">&quot;1000&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!--关闭连接时，是否提交未提交的事务，默认为false，即关闭连接，回滚未提交的事务 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;autoCommitOnClose&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!--如果为false，则获取连接失败将会引起所有等待连接池来获取连接的线程抛出异常，但是数据源仍有效保留，并在下次调用getConnection()的时候继续尝试获取连接。如果设为true，那么在尝试获取连接失败后该数据源将申明已断开并永久关闭。默认: </span>
<span class="c">            false --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;breakAfterAcquireFailure&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!--每60秒检查所有连接池中的空闲连接。默认值: 0，不检查 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;idleConnectionTestPeriod&quot;</span> <span class="na">value=</span><span class="s">&quot;60&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!--c3p0全局的PreparedStatements缓存的大小。如果maxStatements与maxStatementsPerConnection均为0，则缓存不生效，只要有一个不为0，则语句的缓存就能生效。如果默认值: </span>
<span class="c">            0 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxStatements&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!--maxStatementsPerConnection定义了连接池内单个连接所拥有的最大缓存statements数。默认值: 0 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxStatementsPerConnection&quot;</span> <span class="na">value=</span><span class="s">&quot;10&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sessionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.orm.hibernate4.LocalSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 配置数据源 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 扫描包 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;packagesToScan&quot;</span> <span class="na">value=</span><span class="s">&quot;org.daxiang.resume.po&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!--hibernate参数配置 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernateProperties&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;props&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;hibernate.dialect&quot;</span><span class="nt">&gt;</span> org.hibernate.dialect.MySQLDialect <span class="nt">&lt;/prop&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;hibernate.show_sql&quot;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/prop&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;hibernate.current_session_context_class&quot;</span><span class="nt">&gt;</span>org.springframework.orm.hibernate4.SpringSessionContext<span class="nt">&lt;/prop&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;jdbc.use_scrollable_resultset&quot;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/prop&gt;</span>
                <span class="c">&lt;!-- &lt;prop key=&quot;hibernate.hbm2ddl.auto&quot;&gt;none&lt;/prop&gt; </span>
<span class="c">                     &lt;prop key=&quot;hibernate.jdbc.fetch_size&quot;&gt;50&lt;/prop&gt; </span>
<span class="c">                     &lt;prop key=&quot;hibernate.jdbc.batch_size&quot;&gt;30&lt;/prop&gt; --&gt;</span>
            <span class="nt">&lt;/props&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</pre></div>


<p>web.xml中加入</p>
<div class="hlcode"><pre><span class="c">&lt;!-- 配置Session --&gt;</span>
<span class="nt">&lt;filter&gt;</span>
<span class="nt">&lt;filter-name&gt;</span>openSession<span class="nt">&lt;/filter-name&gt;</span>
<span class="nt">&lt;filter-class&gt;</span>org.springframework.orm.hibernate4.support.OpenSessionInViewFilter<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
<span class="nt">&lt;filter-name&gt;</span>openSession<span class="nt">&lt;/filter-name&gt;</span>
<span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>


<h5 id="mybatis">整合mybatis</h5>
<p>spring-mybatis配置文件</p>
<div class="hlcode"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:p=</span><span class="s">&quot;http://www.springframework.org/schema/p&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
<span class="s">      http://www.springframework.org/schema/context</span>
<span class="s">      http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 引入jdbc配置文件 --&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">&quot;classpath:jdbc.properties&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="na">init-method=</span><span class="s">&quot;init&quot;</span>
          <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>${jdbc.driver}<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>${jdbc.url}<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>${jdbc.username}<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>${jdbc.password}<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 连接池最大使用连接数 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxActive&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>20<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 初始化连接大小 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;initialSize&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>1<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 获取连接最大等待时间 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxWait&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>60000<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 连接池最大空闲 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>20<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 连接池最小空闲 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minIdle&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>3<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 自动清除无用连接 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;removeAbandoned&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 清除无用连接的等待时间 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;removeAbandonedTimeout&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>180<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!-- 连接属性 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionProperties&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>clientEncoding=UTF-8<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- spring和MyBatis完美整合，不需要mybatis的配置映射文件 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 加载mybatis的配置文件 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span> <span class="na">value=</span><span class="s">&quot;classpath:mybatis/mybatis-config.xml&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="c">&lt;!-- 自动扫描mapping.xml文件 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mapperLocations&quot;</span> <span class="na">value=</span><span class="s">&quot;classpath:com/houmingjian/practice/dao/*.xml&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSession&quot;</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- spring与mybatis整合配置，扫描所有dao --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>
          <span class="na">p:basePackage=</span><span class="s">&quot;com.houmingjian.practice.dao&quot;</span>
          <span class="na">p:sqlSessionFactoryBeanName=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 对数据源进行事务管理 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>
          <span class="na">p:dataSource-ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 允许使用注解进行事务配置 --&gt;</span>
    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">&quot;transactionManager&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>


<h3 id="spring_1">Spring事务配置</h3>
<h5 id="aop">AOP层控制事务</h5>
<div class="hlcode"><pre><span class="c">&lt;!-- 通知 --&gt;</span>
<span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">&quot;txAdvice&quot;</span> <span class="na">transaction-manager=</span><span class="s">&quot;transactionManager&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tx:attributes&gt;</span>
  <span class="c">&lt;!-- 传播行为 --&gt;</span>
  <span class="c">&lt;!-- 顺序，*优先级最低，处理查询数据的操作默认不开启事务 --&gt;</span>
  <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;get*&quot;</span> <span class="na">propagation=</span><span class="s">&quot;SUPPORTS&quot;</span> <span class="na">read-only=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;find*&quot;</span> <span class="na">propagation=</span><span class="s">&quot;SUPPORTS&quot;</span> <span class="na">read-only=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;search*&quot;</span> <span class="na">propagation=</span><span class="s">&quot;SUPPORTS&quot;</span> <span class="na">read-only=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;load*&quot;</span> <span class="na">propagation=</span><span class="s">&quot;SUPPORTS&quot;</span> <span class="na">read-only=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;*&quot;</span> <span class="na">propagation=</span><span class="s">&quot;REQUIRED&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/tx:attributes&gt;</span>
<span class="nt">&lt;/tx:advice&gt;</span>
</pre></div>


<p>经过实践，发现*号的优先度是最低的。这样配置可以实现除了get，find，search，load等纯读取方法外，其余方法都是会开启事务。</p>
<h5 id="_2">注解控制事务</h5>
<p>spring配置文件中加入</p>
<div class="hlcode"><pre>    <span class="c">&lt;!-- 对数据源进行事务管理 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>
          <span class="na">p:dataSource-ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 允许使用注解进行事务配置 --&gt;</span>
    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">&quot;transactionManager&quot;</span> <span class="nt">/&gt;</span>
</pre></div>


<p>然后在类的开头就可以加上注解</p>
<div class="hlcode"><pre><span class="err">@</span><span class="n">Transactional</span>
</pre></div>


<p>如果想手工管理事务，则可以使用编程式事务管理。</p>
<div class="hlcode"><pre><span class="err">@</span><span class="n">Autowired</span>
<span class="n">private</span> <span class="n">DataSourceTransactionManager</span> <span class="n">txManager</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">DefaultTransactionDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultTransactionDefinition</span><span class="p">();</span>
<span class="n">def</span><span class="p">.</span><span class="n">setPropagationBehavior</span><span class="p">(</span><span class="n">TransactionDefinition</span><span class="p">.</span><span class="n">PROPAGATION_REQUIRED</span><span class="p">);</span>
<span class="c1">// 开启事务</span>
<span class="n">TransactionStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">txManager</span><span class="p">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
<span class="n">try</span><span class="p">{</span>
  <span class="n">txManager</span><span class="p">.</span><span class="n">commit</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span><span class="n">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">){</span>
  <span class="n">txManager</span><span class="p">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<h3 id="springmybaits">Spring整合Mybaits</h3>
<h5 id="mybatis_1">配置mybatis的环境</h5>
<p>引入mybatis相关的包</p>
<div class="hlcode"><pre><span class="c">&lt;!-- mybatis开始 --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis-spring<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.mybatis.generator<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis-generator-core<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.3.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>     
</pre></div>


<p>在resource文件夹下新建mybatis-config文件，里面存放的是mybatis的配置</p>
<div class="hlcode"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="c">&lt;!-- 别名 --&gt;</span>
    <span class="nt">&lt;typeAliases&gt;</span>
        <span class="c">&lt;!-- 批量扫描domain别名 --&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.houmingjian.practice.po&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/typeAliases&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>


<p>这篇讲得不错</p>
<p>http://hwak.iteye.com/blog/1611970</p>
<h3 id="aop_1">AOP</h3>
<p><strong>在这里就只是简单的列举一下实践，更多的使用以后再归纳整理。</strong><br />
举个例子：<br />
首先，aop我们一般会放在service中，我们先定义一个接口名字，名字就叫ISleepServiceInter</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ISleepServiceInter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<p>然后，我们实现写一个他的实现类SleepServiceImpl</p>
<div class="hlcode"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SleepServiceImpl</span> <span class="kd">implements</span> <span class="n">ISleepServiceInter</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;蛤铪：睡觉ing。。。。。。&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>然后我们开始写aop的类</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SleepAop</span> <span class="kd">implements</span> <span class="n">MethodBeforeAdvice</span><span class="o">,</span> <span class="n">AfterReturningAdvice</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterReturning</span><span class="o">(</span><span class="n">Object</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Method</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">Object</span> <span class="n">arg3</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;蛤铪：昨天搞的这个大新闻啊。。。。exicted！&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="n">Method</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">Object</span> <span class="n">arg2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;蛤铪：睡觉之前，先搞个大新闻！&quot;</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>最后配置xml文件</p>
<div class="hlcode"><pre>    <span class="c">&lt;!-- aop发生的地点 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sleepCutPoint&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.aop.support.JdkRegexpMethodPointcut&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;pattern&quot;</span> <span class="na">value=</span><span class="s">&quot;.*sleep&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sleepAop&quot;</span> <span class="na">class=</span><span class="s">&quot;com.houmingjian.mblog.service.aop.SleepAop&quot;</span><span class="nt">&gt;&lt;/bean&gt;</span>  

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sleepHelperAdvisor&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.aop.support.DefaultPointcutAdvisor&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;advice&quot;</span> <span class="na">ref=</span><span class="s">&quot;sleepAop&quot;</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;pointcut&quot;</span> <span class="na">ref=</span><span class="s">&quot;sleepCutPoint&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>

     <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator&quot;</span><span class="nt">/&gt;</span>  
</pre></div>


<p>当然也可以用注释的方法来做~</p>
<p>最近看了一下部分AOP的源码。。起初是因为想不通，为什么一个方法调用同一个类里面的带事务方法，事务不起作用。看了源码之后明白了。因为Spring创建代理对象，是在获取Bean的时候生成代替的，例如说A这个类，有不带事务的B方法和带事务的C方法。Spring发现你要调用A的B方法，于是他就去看看B需不需要被代理，发现不需要，就直接从Bean容器中给你返回了A类，然后调用带事务的C方法时，就是直接本类调用了。因为同类调用不需要向Spring获取Bean。</p>
<h4 id="aop_2">事务注解和AOP注解</h4>
<p>当事务注解和自定义的AOP注解在同一个方法上面时，就需要自定义注解的顺序，在Spring中配置事务的地方有一个属性<strong>order</strong>，这个属性的值越小，则执行优先级最高，事务的默认级别是最高的。</p>
<h3 id="spring-cache">Spring-cache</h3>
<p><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-spring-cache/">注释驱动的 Spring cache 缓存介绍</a></p>
<h3 id="quartz">Quartz定时任务</h3>
<p>添加jar包依赖</p>
<div class="hlcode"><pre><span class="c">&lt;!--定时任务--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.quartz-scheduler<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>quartz<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>


<p>定时任务测试类</p>
<div class="hlcode"><pre><span class="err">@</span><span class="n">Service</span><span class="p">(</span><span class="s">&quot;testTask&quot;</span><span class="p">)</span>
<span class="n">public</span> <span class="n">class</span> <span class="n">TestTask</span> <span class="p">{</span>
    <span class="n">Logger</span> <span class="n">logger</span>  <span class="o">=</span> <span class="n">Logger</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">TestTask</span><span class="p">.</span><span class="n">class</span><span class="p">);</span>

    <span class="n">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;执行定时任务&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Spring配置文件中配置该任务</p>
<div class="hlcode"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:p=</span><span class="s">&quot;http://www.springframework.org/schema/p&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span> <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span>
       <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">    http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/context</span>
<span class="s">    http://www.springframework.org/schema/context/spring-context-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/tx</span>
<span class="s">    http://www.springframework.org/schema/tx/spring-tx-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/aop</span>
<span class="s">    http://www.springframework.org/schema/aop/spring-aop-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/util</span>
<span class="s">    http://www.springframework.org/schema/util/spring-util-3.2.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;testTaskDetail&quot;</span>         <span class="na">class=</span><span class="s">&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 指定任务类 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetObject&quot;</span> <span class="na">ref=</span><span class="s">&quot;testTask&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 指定任务执行的方法 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetMethod&quot;</span> <span class="na">value=</span><span class="s">&quot;run&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cronTrigger&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.scheduling.quartz.SimpleTriggerBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jobDetail&quot;</span> <span class="na">ref=</span><span class="s">&quot;testTaskDetail&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;startDelay&quot;</span> <span class="na">value=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;repeatInterval&quot;</span> <span class="na">value=</span><span class="s">&quot;2000&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;triggers&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;list&gt;</span>
                <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;cronTrigger&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>


<p>cronExpression表达式</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>说明</th>
<th>是否必填</th>
<th>允许填写的值</th>
<th>允许的通配符</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>秒</td>
<td>是</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>2</td>
<td>分</td>
<td>是</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>3</td>
<td>小时</td>
<td>是</td>
<td>0-23</td>
<td>, - * /</td>
</tr>
<tr>
<td>4</td>
<td>日</td>
<td>是</td>
<td>1-31</td>
<td>, - * ? / L W</td>
</tr>
<tr>
<td>5</td>
<td>月</td>
<td>是</td>
<td>1-12</td>
<td>, - * /</td>
</tr>
<tr>
<td>6</td>
<td>周</td>
<td>是</td>
<td>1-7</td>
<td>, - * ? / L #</td>
</tr>
<tr>
<td>7</td>
<td>年</td>
<td>否</td>
<td>empty或1970-2099</td>
<td>, - * /</td>
</tr>
</tbody>
</table>
<p>常见例子：</p>
<div class="hlcode"><pre><span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span> <span class="c1">//每一秒</span>
<span class="mi">0</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span> <span class="c1">//每三秒一次</span>
<span class="mi">0</span> <span class="mi">0</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span>  <span class="c1">//每三分钟一次</span>
</pre></div>


<h3 id="springjar">spring引用jar包里面的配置文件</h3>
<p>我们使用maven进行多模块开发时，一般会进行多模块开发。这里举个例子，我们现在有两个模块，分别是A和B，其中A是服务层，B是web层。</p>
<p>A主要是核心业务的代码实现，而B用于向外提供http服务和连接A项目。这两个项目都有spring，这时候我们一般是会将A打包成jar，然后供B调用。但这时候问题来了，B怎么才能同时接管A的spring呢</p>
<p>这时候会用到spring配置文件中的<import>标签，将jar包中的spring配置文件引入到B中。</p>
<div class="hlcode"><pre><span class="o">&lt;</span><span class="kn">import</span> <span class="nn">resource</span><span class="o">=</span><span class="s">&quot;classpath*:/spring/spring-common.xml&quot;</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="kn">import</span> <span class="nn">resource</span><span class="o">=</span><span class="s">&quot;classpath*:/spring/spring-mybatis.xml&quot;</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="kn">import</span> <span class="nn">resource</span><span class="o">=</span><span class="s">&quot;classpath*:/spring/spring-jms.xml&quot;</span> <span class="o">/&gt;</span>
</pre></div>


<h4 id="spring_2">spring扫描</h4>
<p>以前是认为只要配置了下面这个注解，那么spring就会自动去扫描该base-package，并且自动将里面所有的类纳入spring容器管理中，但是最近在做一个spring-cache的东西的时候，发现这个注解只是会起到标记扫描的作用，还是要自己去加注解让spring识别。</p>
<div class="hlcode"><pre><span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.navalon.superdemo.annotation&quot;</span><span class="nt">/&gt;</span>
</pre></div>


<blockquote>
<p>component-scan标签默认情况下自动扫描指定路径下的包（含所有子包），将带有@Component、@Repository、@Service、@Controller标签的类自动注册到spring容器。对标记了 Spring's @Required、@Autowired、JSR250's @PostConstruct、@PreDestroy、@Resource、JAX-WS's @WebServiceRef、EJB3's @EJB、JPA's @PersistenceContext、@PersistenceUnit等注解的类进行对应的操作使注解生效（包含了annotation-config标签的作用）。</p>
</blockquote>
<h4 id="aop_3">开启aop</h4>
<div class="hlcode"><pre><span class="nt">&lt;aop:aspectj-autoproxy</span> <span class="nt">/&gt;</span> 
</pre></div>


<h4 id="spring-test">Spring-test</h4>
<p>若想执行测试用例的时候回滚，则在测试用例的头部加入</p>
<div class="hlcode"><pre><span class="err">@</span><span class="n">TransactionConfiguration</span><span class="p">(</span><span class="n">transactionManager</span> <span class="o">=</span> <span class="s">&quot;transactionManager&quot;</span><span class="p">,</span> <span class="n">defaultRollback</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
</pre></div>


<h3 id="spring_3">Spring加载顺序比静态类加载慢的问题</h3>
<p>这是我在17-2-20日碰到的一个小坑，记录下来看看。</p>
<p>很简单的一个例子：</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SettingContext</span> <span class="kd">implements</span> <span class="n">InitializingBean</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SettingService</span> <span class="n">settingServiceStatic</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">SettingService</span> <span class="n">settingService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">String</span><span class="o">...</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">settingServiceStatic</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">defaultValue</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">defaultValue</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">defaultValue</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">settingServiceStatic</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">SettingContext</span><span class="o">.</span><span class="na">settingServiceStatic</span> <span class="o">=</span> <span class="n">appSettingService</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>上面的代码会有一个问题，当启动应用时，会先加载静态类，后加载spring容器，当spring容器还没加载完全时，settingService为空时，刚好有一个服务会调用到静态的getValue方法，导致settingServiceStatic被置为空了。服务就会出现异常。</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2017 侯铭健.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2017-07-08 13:22:44</p>
      </span>
    </div>

    
    
  </body>
</html>