<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Spring基础 - Miguel's Wiki</title>
    <meta name="keywords" content=""/>
    <meta name="description" content="Miguel个人wiki"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="referrer" content="no-referrer" />
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/wiki/">Home</a>&nbsp;&#187;&nbsp;<a href="/wiki/#Java">Java</a>&nbsp;&#187;&nbsp;Spring基础
    <span class="updated">Page Updated&nbsp;
      2016-06-24 16:57:46
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Spring基础</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#spring">Spring事务</a><ul>
<li><a href="#_1">注解控制事务(推荐)</a></li>
<li><a href="#_2">关于事务注解的一些坑点</a></li>
<li><a href="#aop">事务注解和AOP注解</a></li>
</ul>
</li>
<li><a href="#aop_1">AOP的使用</a></li>
<li><a href="#spring-cache">Spring-cache</a></li>
<li><a href="#quartz">Quartz定时任务</a></li>
<li><a href="#springjar">spring引用jar包里面的配置文件</a></li>
<li><a href="#spring-test">Spring Test回滚</a></li>
<li><a href="#spring_1">Spring加载顺序比静态类加载慢的问题</a></li>
<li><a href="#bean">自定义bean初始化后行为</a></li>
</ul>
</div>
<h2 id="spring">Spring事务</h2>
<h3 id="_1">注解控制事务(<strong>推荐</strong>)</h3>
<p>spring配置文件中加入</p>
<div class="hlcode"><pre>    <span class="c">&lt;!-- 对数据源进行事务管理 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>
          <span class="na">p:dataSource-ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 允许使用注解进行事务配置 --&gt;</span>
    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">&quot;transactionManager&quot;</span> <span class="nt">/&gt;</span>
</pre></div>


<p>然后在类的开头就可以加上注解 <code>@Transactional</code></p>
<h3 id="_2">关于事务注解的一些坑点</h3>
<p>最近看了一下部分AOP的源码。。起初是因为想不通，为什么一个方法调用同一个类里面的带事务方法，事务不起作用。</p>
<p>看了源码之后明白了。因为Spring创建代理对象，是在获取Bean的时候生成代替的。</p>
<p>例如说A这个类，有不带事务的B方法和带事务的C方法。Spring发现你要调用A的B方法，于是他就去看看B需不需要被代理(通过AOP)，若发现不需要，就直接从Bean容器中给你返回了A类，然后调用带事务的C方法时，就是直接本类调用了。因为同类调用不需要向Spring获取Bean。</p>
<h3 id="aop">事务注解和AOP注解</h3>
<p>当事务注解和自定义的AOP注解在同一个方法上面时，就需要自定义注解的顺序，在Spring中配置事务的地方有一个属性<strong>order</strong>，这个属性的值越小，则执行优先级最高，事务的默认级别是最高的。</p>
<h2 id="aop_1">AOP的使用</h2>
<p>在这里就只是简单的列举一下实践，更多的使用以后再归纳整理。</p>
<p>举个例子：<br />
首先，aop我们一般会放在service中，我们先定义一个接口名字，名字就叫ISleepServiceInter</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ISleepServiceInter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<p>然后，我们实现写一个他的实现类SleepServiceImpl</p>
<div class="hlcode"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SleepServiceImpl</span> <span class="kd">implements</span> <span class="n">ISleepServiceInter</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;蛤铪：睡觉ing。。。。。。&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>然后我们开始写aop的类</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SleepAop</span> <span class="kd">implements</span> <span class="n">MethodBeforeAdvice</span><span class="o">,</span> <span class="n">AfterReturningAdvice</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterReturning</span><span class="o">(</span><span class="n">Object</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Method</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">Object</span> <span class="n">arg3</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;蛤铪：昨天搞的这个大新闻啊。。。。exicted！&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="n">Method</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">Object</span> <span class="n">arg2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;蛤铪：睡觉之前，先搞个大新闻！&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>最后配置xml文件</p>
<div class="hlcode"><pre>    <span class="c">&lt;!-- aop发生的地点 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sleepCutPoint&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.aop.support.JdkRegexpMethodPointcut&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;pattern&quot;</span> <span class="na">value=</span><span class="s">&quot;.*sleep&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sleepAop&quot;</span> <span class="na">class=</span><span class="s">&quot;com.houmingjian.mblog.service.aop.SleepAop&quot;</span><span class="nt">&gt;&lt;/bean&gt;</span>  

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sleepHelperAdvisor&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.aop.support.DefaultPointcutAdvisor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;advice&quot;</span> <span class="na">ref=</span><span class="s">&quot;sleepAop&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;pointcut&quot;</span> <span class="na">ref=</span><span class="s">&quot;sleepCutPoint&quot;</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator&quot;</span><span class="nt">/&gt;</span>  
</pre></div>


<p>当然也可以用注释的方法来做~</p>
<h2 id="spring-cache">Spring-cache</h2>
<p>2018-7-16更新：Spring-cache因为缺少时间</p>
<p><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-spring-cache/">注释驱动的 Spring cache 缓存介绍</a></p>
<h2 id="quartz">Quartz定时任务</h2>
<p>添加jar包依赖</p>
<div class="hlcode"><pre><span class="c">&lt;!--定时任务--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.quartz-scheduler<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>quartz<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>


<p>定时任务测试类</p>
<div class="hlcode"><pre><span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;testTask&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTask</span> <span class="o">{</span>
    <span class="n">Logger</span> <span class="n">logger</span>  <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">TestTask</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;执行定时任务&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Spring配置文件中配置该任务</p>
<div class="hlcode"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:p=</span><span class="s">&quot;http://www.springframework.org/schema/p&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span> <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span>
       <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">    http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/context</span>
<span class="s">    http://www.springframework.org/schema/context/spring-context-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/tx</span>
<span class="s">    http://www.springframework.org/schema/tx/spring-tx-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/aop</span>
<span class="s">    http://www.springframework.org/schema/aop/spring-aop-3.2.xsd</span>
<span class="s">    http://www.springframework.org/schema/util</span>
<span class="s">    http://www.springframework.org/schema/util/spring-util-3.2.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;testTaskDetail&quot;</span>         <span class="na">class=</span><span class="s">&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 指定任务类 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetObject&quot;</span> <span class="na">ref=</span><span class="s">&quot;testTask&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 指定任务执行的方法 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetMethod&quot;</span> <span class="na">value=</span><span class="s">&quot;run&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cronTrigger&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.scheduling.quartz.SimpleTriggerBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jobDetail&quot;</span> <span class="na">ref=</span><span class="s">&quot;testTaskDetail&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;startDelay&quot;</span> <span class="na">value=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;repeatInterval&quot;</span> <span class="na">value=</span><span class="s">&quot;2000&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;triggers&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;list&gt;</span>
                <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;cronTrigger&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>


<p>cronExpression表达式</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>说明</th>
<th>是否必填</th>
<th>允许填写的值</th>
<th>允许的通配符</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>秒</td>
<td>是</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>2</td>
<td>分</td>
<td>是</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>3</td>
<td>小时</td>
<td>是</td>
<td>0-23</td>
<td>, - * /</td>
</tr>
<tr>
<td>4</td>
<td>日</td>
<td>是</td>
<td>1-31</td>
<td>, - * ? / L W</td>
</tr>
<tr>
<td>5</td>
<td>月</td>
<td>是</td>
<td>1-12</td>
<td>, - * /</td>
</tr>
<tr>
<td>6</td>
<td>周</td>
<td>是</td>
<td>1-7</td>
<td>, - * ? / L #</td>
</tr>
<tr>
<td>7</td>
<td>年</td>
<td>否</td>
<td>empty或1970-2099</td>
<td>, - * /</td>
</tr>
</tbody>
</table>
<p>常见例子：</p>
<div class="hlcode"><pre><span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span> <span class="c1">//每一秒</span>
<span class="mi">0</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span> <span class="c1">//每三秒一次</span>
<span class="mi">0</span> <span class="mi">0</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span>  <span class="c1">//每三分钟一次</span>
</pre></div>


<h2 id="springjar">spring引用jar包里面的配置文件</h2>
<p>我们使用maven进行多模块开发时，一般会进行多模块开发。这里举个例子，我们现在有两个模块，分别是A和B，其中A是服务层，B是web层。</p>
<p>A主要是核心业务的代码实现，而B用于向外提供http服务和连接A项目。这两个项目都有spring，这时候我们一般是会将A打包成jar，然后供B调用。但这时候问题来了，B怎么才能同时接管A的spring呢</p>
<p>这时候会用到spring配置文件中的 <code>&lt;import&gt;</code> 标签，将jar包中的spring配置文件引入到B中。</p>
<div class="hlcode"><pre><span class="o">&lt;</span><span class="kn">import</span> <span class="nn">resource</span><span class="o">=</span><span class="s">&quot;classpath*:/spring/spring-common.xml&quot;</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="kn">import</span> <span class="nn">resource</span><span class="o">=</span><span class="s">&quot;classpath*:/spring/spring-mybatis.xml&quot;</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="kn">import</span> <span class="nn">resource</span><span class="o">=</span><span class="s">&quot;classpath*:/spring/spring-jms.xml&quot;</span> <span class="o">/&gt;</span>
</pre></div>


<h2 id="spring-test">Spring Test回滚</h2>
<p>若想执行测试用例的时候回滚，则在测试用例的头部加入</p>
<div class="hlcode"><pre><span class="err">@</span><span class="n">TransactionConfiguration</span><span class="p">(</span><span class="n">transactionManager</span> <span class="o">=</span> <span class="s">&quot;transactionManager&quot;</span><span class="p">,</span> <span class="n">defaultRollback</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
</pre></div>


<h2 id="spring_1">Spring加载顺序比静态类加载慢的问题</h2>
<p>这是我在17-2-20日碰到的一个小坑，记录下来看看。</p>
<p>很简单的一个例子：</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SettingContext</span> <span class="kd">implements</span> <span class="n">InitializingBean</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SettingService</span> <span class="n">settingServiceStatic</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">SettingService</span> <span class="n">settingService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">String</span><span class="o">...</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">settingServiceStatic</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">defaultValue</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">defaultValue</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">defaultValue</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">settingServiceStatic</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">SettingContext</span><span class="o">.</span><span class="na">settingServiceStatic</span> <span class="o">=</span> <span class="n">appSettingService</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>上面的代码会有一个问题，当启动应用时，会先加载静态类，后加载spring容器，当spring容器还没加载完全时，settingService为空时，刚好有一个服务会调用到静态的getValue方法，导致settingServiceStatic被置为空了。服务就会出现异常。</p>
<h2 id="bean">自定义bean初始化后行为</h2>
<p>有三种方式可以自定义bean初始化后的行为</p>
<ol>
<li>通过bean实现<code>InitializingBean</code>接口，重写<code>afterPropertiesSet</code>方法</li>
<li>在xml中定义<code>init-method</code>方法</li>
<li>通过<code>@PostConstruct</code>注解</li>
</ol>
<p>需要注意的点是</p>
<ul>
<li><code>@PostConstruct</code>是JSR-250注解，类似于<code>@Resource</code></li>
<li>三者的执行顺序 <code>@PostConstruct</code> &gt; <code>afterPropertiesSet</code> &gt; <code>init-method</code></li>
</ul>
<p>个人更倾向于使用第三种注解的方式来做bean初始化后的操作</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Miguel.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-06-26 11:37:16</p>
      </span>
    </div>

    
    
  </body>
</html>